rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function userExists() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdmin() {
      return userExists() &&
             getUserData().role == 'admin' &&
             getUserData().active == true;
    }

    function isProfissional() {
      return userExists() &&
             getUserData().role == 'profissional' &&
             getUserData().active == true;
    }

    function isSupervisor() {
      return userExists() &&
             getUserData().role == 'supervisor' &&
             getUserData().active == true;
    }

    function isStaff() {
      return isAdmin() || isProfissional() || isSupervisor();
    }

    function isActive() {
      return userExists() && getUserData().active == true;
    }

    match /users/{userId} {
      allow read: if isAuthenticated() &&
                     (request.auth.uid == userId || isAdmin());

      allow create: if isAdmin();

      allow update: if isAdmin() ||
                       (isAuthenticated() &&
                        request.auth.uid == userId &&
                        request.resource.data.role == resource.data.role &&
                        request.resource.data.active == resource.data.active);

      allow delete: if isAdmin();
    }

    match /vacinas/{vacinaId} {
      allow read: if true;

      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /avisos/{avisoId} {
      allow read: if (resource.data.ativo == true &&
                     resource.data.exibirNaHomepage == true) ||
                     isStaff();

      allow create: if isStaff();
      allow update: if isStaff();

      allow delete: if isAdmin() || isSupervisor();
    }

    match /campanhas/{campanhaId} {
      allow read: if resource.data.ativo == true || isStaff();

      allow create: if isStaff();
      allow update: if isStaff();

      allow delete: if isAdmin() ||
                       (isProfissional() && resource.data.criadoPor == request.auth.uid);
    }

    match /calendario_eventos/{eventoId} {
      allow read: if isStaff();

      allow create: if isStaff();

      allow update: if isStaff();

      allow delete: if isAdmin() ||
                       (isProfissional() && resource.data.criadoPor == request.auth.uid);
    }

    match /escalas/{escalaId} {
      allow read: if isStaff();

      allow create: if isStaff();

      allow update: if isStaff();

      allow delete: if isAdmin();
    }

    match /agendas_semanais/{agendaId} {
      allow read: if true;

      allow create: if isStaff();
      allow update: if isStaff();

      allow delete: if isAdmin();
    }

    match /notificacoes/{notificacaoId} {
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid || isAdmin());

      allow create: if isAdmin();

      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid || isAdmin());
    }

    match /feedbacks/{feedbackId} {
      allow create: if true;

      allow read: if isAdmin();

      allow update: if isAdmin();

      allow delete: if isAdmin();
    }

    match /employees/{employeeId} {
      allow read: if isStaff();

      allow create: if isAdmin();

      allow update: if isAdmin();

      allow delete: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}

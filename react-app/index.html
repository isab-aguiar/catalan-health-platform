<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Language" content="pt-BR" />
    <link rel="icon" type="image/png" href="/logo-favicon.png" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ESF Catalão - Estratégia Saúde da Família</title>

    <link rel="preconnect" href="https://firebase.googleapis.com" crossorigin />
    <link
      rel="preconnect"
      href="https://firestore.googleapis.com"
      crossorigin
    />
    <link rel="preconnect" href="https://storage.googleapis.com" crossorigin />
    <link
      rel="preconnect"
      href="https://identitytoolkit.googleapis.com"
      crossorigin
    />
    <link rel="dns-prefetch" href="https://vlibras.gov.br" />
  </head>
  <body class="overflow-x-hidden">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <!-- VLibras Widget Container -->
    <div vw class="enabled">
      <div vw-access-button class="active"></div>
      <div vw-plugin-wrapper>
        <div class="vw-plugin-top-wrapper"></div>
      </div>
    </div>

    <script>
      // Variável para controle de tentativas
      var vlibrasRetries = 0;
      var maxVlibrasRetries = 10;
      var vlibrasInitialized = false;

      // Função para inicializar VLibras com tratamento de erro robusto
      function initVLibras() {
        if (vlibrasInitialized) return;
        
        try {
          if (window.VLibras && window.VLibras.Widget) {
            new window.VLibras.Widget('https://vlibras.gov.br/app');
            vlibrasInitialized = true;
            console.log('VLibras inicializado com sucesso');

            // Forçar posicionamento e visibilidade após inicialização
            setTimeout(function() {
              fixVLibrasPosition();
            }, 1000);

            // Verificar novamente após mais tempo (para garantir em dispositivos lentos)
            setTimeout(function() {
              fixVLibrasPosition();
            }, 3000);

            // Observer para garantir que o widget permaneça visível
            observeVLibras();
          } else if (vlibrasRetries < maxVlibrasRetries) {
            vlibrasRetries++;
            console.log('VLibras não disponível, tentativa ' + vlibrasRetries + '/' + maxVlibrasRetries);
            setTimeout(initVLibras, 500);
          } else {
            console.warn('VLibras: número máximo de tentativas atingido');
          }
        } catch (error) {
          console.warn('VLibras não pôde ser carregado:', error.message);
          if (vlibrasRetries < maxVlibrasRetries) {
            vlibrasRetries++;
            setTimeout(initVLibras, 500);
          }
        }
      }

      // Função para corrigir posição do VLibras
      function fixVLibrasPosition() {
        var vwDiv = document.querySelector('div[vw]');
        var accessButton = document.querySelector('[vw-access-button]');
        var pluginWrapper = document.querySelector('[vw-plugin-wrapper]');

        if (vwDiv) {
          vwDiv.classList.add('enabled');
          vwDiv.style.cssText = 'position: fixed !important; bottom: 100px !important; right: 10px !important; left: auto !important; z-index: 9999999 !important; display: block !important; visibility: visible !important; opacity: 1 !important;';
        }

        if (accessButton) {
          accessButton.classList.add('active');
          accessButton.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; cursor: pointer !important;';
        }

        if (pluginWrapper) {
          pluginWrapper.style.cssText = 'pointer-events: auto !important;';
        }
      }

      // Observer para manter VLibras visível
      function observeVLibras() {
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' || mutation.type === 'childList') {
              var vwDiv = document.querySelector('div[vw]');
              if (vwDiv && (vwDiv.style.display === 'none' || vwDiv.style.visibility === 'hidden')) {
                fixVLibrasPosition();
              }
              
              // Verificar se o widget está aberto para esconder/mostrar o botão
              toggleAccessButton();
            }
          });
        });

        var vwDiv = document.querySelector('div[vw]');
        if (vwDiv) {
          observer.observe(vwDiv, { attributes: true, childList: true, subtree: true });
        }
      }

      // Função para esconder/mostrar o botão quando o widget abre/fecha
      function toggleAccessButton() {
        var accessButton = document.querySelector('[vw-access-button]');
        var pluginWrapper = document.querySelector('[vw-plugin-wrapper]');
        var vpBox = document.querySelector('.vp-box');
        var topWrapper = document.querySelector('.vw-plugin-top-wrapper');
        
        // Verificar se o widget está aberto (tem conteúdo visível)
        var isWidgetOpen = (vpBox && vpBox.offsetHeight > 0) || 
                          (topWrapper && topWrapper.children.length > 0 && topWrapper.offsetHeight > 0) ||
                          (pluginWrapper && pluginWrapper.classList.contains('active'));
        
        if (accessButton) {
          if (isWidgetOpen) {
            accessButton.style.display = 'none';
            accessButton.style.visibility = 'hidden';
            accessButton.style.opacity = '0';
          } else {
            accessButton.style.display = 'block';
            accessButton.style.visibility = 'visible';
            accessButton.style.opacity = '1';
          }
        }
      }

      // Expor função globalmente
      window.toggleAccessButton = toggleAccessButton;

      // Reinicializar VLibras quando a janela for redimensionada
      var resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          fixVLibrasPosition();
        }, 250);
      });

      // Garantir que VLibras funcione após navegação SPA
      window.addEventListener('popstate', function() {
        setTimeout(fixVLibrasPosition, 500);
      });
    </script>

    <script
      src="https://vlibras.gov.br/app/vlibras-plugin.js"
      onload="initVLibras()"
      onerror="console.warn('Erro ao carregar script VLibras - tentando novamente'); setTimeout(function() { var s = document.createElement('script'); s.src = 'https://vlibras.gov.br/app/vlibras-plugin.js'; s.onload = initVLibras; document.body.appendChild(s); }, 2000);"
      async
    ></script>

    <style>
      /* VLibras - Estilos base */
      div[vw] {
        position: fixed !important;
        bottom: 100px !important;
        right: 10px !important;
        left: auto !important;
        z-index: 9999999 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      div[vw].enabled {
        display: block !important;
        visibility: visible !important;
      }

      [vw-access-button] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: auto !important;
        cursor: pointer !important;
        position: relative !important;
        z-index: 9999999 !important;
        -webkit-tap-highlight-color: transparent !important;
        touch-action: manipulation !important;
      }

      [vw-access-button].active {
        display: block !important;
        visibility: visible !important;
      }

      /* Popup/Badge de acessibilidade em Libras - aparece no hover */
      [vw-access-button] .vp-pop-up,
      .vp-pop-up {
        display: none !important;
        position: absolute !important;
        right: 60px !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        z-index: 9999999 !important;
        visibility: visible !important;
        opacity: 1 !important;
        pointer-events: none !important;
        max-width: 200px !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2) !important;
      }

      [vw-access-button]:hover .vp-pop-up,
      [vw-access-button].active:hover .vp-pop-up {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Ícone do botão de acesso */
      [vw-access-button] .vp-access-button,
      .vp-access-button {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 50px !important;
        height: 50px !important;
        cursor: pointer !important;
        transition: transform 0.3s ease !important;
      }

      [vw-access-button]:hover .vp-access-button {
        transform: translateX(-10px) !important;
      }

      /* Esconder o ícone quando o widget está aberto */
      div[vw].enabled [vw-access-button].active[style*="display: none"],
      div[vw] .vw-plugin-top-wrapper:not(:empty) ~ [vw-access-button],
      div[vw].enabled .vp-box ~ [vw-access-button] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }

      /* Quando o player/widget está visível, esconder o botão */
      div[vw] [vw-plugin-wrapper].active ~ [vw-access-button],
      div[vw] .vw-plugin-top-wrapper.active ~ [vw-access-button],
      div[vw].enabled .vp-wrapper-active [vw-access-button] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
      }

      [vw-plugin-wrapper] {
        pointer-events: auto !important;
        position: relative !important;
        z-index: 9999999 !important;
      }

      [vw-plugin-wrapper] * {
        pointer-events: auto !important;
      }

      /* VLibras - Estilos para o player/tradutor */
      .vw-plugin-top-wrapper,
      .vp-box,
      .vw-plugin-wrapper .vp-box {
        pointer-events: auto !important;
        touch-action: auto !important;
      }

      /* Garantir que não seja coberto por outros elementos */
      div[vw],
      div[vw] * {
        box-sizing: border-box !important;
      }

      /* Fix para evitar conflito com footer fixo */
      div[vw].enabled {
        margin-bottom: env(safe-area-inset-bottom, 0px) !important;
      }
    </style>
  </body>
</html>
